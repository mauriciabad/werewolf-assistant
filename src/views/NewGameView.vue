<script setup lang="ts">
import type { CharacterId } from "@/data/characters.types";
import {
  useGameConfigStore,
  type AbilitiesConfig,
  type CharacterConfig,
} from "@/stores/gameConfig";
import { SparklesIcon } from "@heroicons/vue/solid";
import { storeToRefs } from "pinia";
import { computed, reactive } from "vue";
import { useRouter } from "vue-router";
import IconButton from "../components/IconButton.vue";
import InputNumber from "../components/InputNumber.vue";
import { default as charactersInfo } from "../data/characters";
import { default as abilitiesInfo } from "../data/abilities";
import type { AbilityId } from "@/data/abilities.types";

const gameConfigStore = useGameConfigStore();

const { characters, abilities } = storeToRefs(gameConfigStore);

const newCharacters = reactive<CharacterConfig[]>(characters.value);
const newCharacterCount = computed<number>(() =>
  newCharacters.reduce((total, { amount }) => total + amount, 0)
);
const newAbilities = reactive<AbilitiesConfig[]>(abilities.value);
const newAbilityCount = computed<number>(() =>
  newAbilities.reduce((total, { amount }) => total + amount, 0)
);
const newAbilitiesPerCharacter = computed<number>(() =>
  newCharacterCount.value === 0
    ? 0
    : Math.floor(newAbilityCount.value / newCharacterCount.value)
);

const { createNewGame } = gameConfigStore;

const router = useRouter();

function setCharacterAmount(characterId: CharacterId, amount: number): void {
  const character = newCharacters.find(
    (character) => character.id === characterId
  );

  if (amount === 0) {
    if (!character) return;

    newCharacters.splice(newCharacters.indexOf(character), 1);
    return;
  }

  if (!character) {
    newCharacters.push({ id: characterId, amount });
    return;
  }

  character.amount = amount;
}

function setAbilityAmount(abilityId: AbilityId, amount: number): void {
  const ability = newAbilities.find((character) => character.id === abilityId);

  if (amount === 0) {
    if (!ability) return;

    newAbilities.splice(newAbilities.indexOf(ability), 1);
    return;
  }

  if (!ability) {
    newAbilities.push({ id: abilityId, amount });
    return;
  }

  ability.amount = amount;
}

function handleCreateGame(): void {
  createNewGame(newCharacters, newAbilities);
  router.push({ name: "dealer" });
}
</script>

<template>
  <main class="main">
    <h1>New Game</h1>

    <h2>Choose characters</h2>
    <p>Total {{ newCharacterCount }}</p>

    <div class="list">
      <div v-for="character in charactersInfo" :key="character.id" class="list__item-wrapper">
        <label :for="character.id" class="list__item-label">
          {{
          character.name
          }}
        </label>
        <InputNumber
          @input="setCharacterAmount(character.id, $event)"
          :id="character.id"
          :default="
            newCharacters.find((c) => c.id === character.id)?.amount ?? 0
          "
        />
      </div>
    </div>

    <h2>Choose abilities</h2>
    <p>
      Total {{ newAbilityCount }} and {{ newAbilitiesPerCharacter }} per
      character
    </p>

    <div class="list">
      <div v-for="ability in abilitiesInfo" :key="ability.id" class="list__item-wrapper">
        <label :for="ability.id" class="list__item-label">
          {{
          ability.name
          }}
        </label>
        <InputNumber
          @input="setAbilityAmount(ability.id, $event)"
          :id="ability.id"
          :default="newAbilities.find((a) => a.id === ability.id)?.amount ?? 0"
        />
      </div>
    </div>

    <IconButton @click="handleCreateGame" :disabled="newCharacterCount <= 1" class="create-button">
      <template v-slot:icon>
        <SparklesIcon />
      </template>Create game
    </IconButton>
  </main>
</template>

<style scoped lang="scss">
.main {
  text-align: center;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.list {
  width: 100%;
  max-width: 25rem;
  text-align: left;
  margin-top: 1rem;

  &__item {
    width: 100%;
    &-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    &-label {
      font-size: 1.2rem;
      flex: 1;
    }
  }
}

.create-button {
  margin-top: 1rem;
}
</style>
